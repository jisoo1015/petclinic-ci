pipeline {
    agent any

    parameters {
        string(
            name: 'IMAGE_TAG',
            defaultValue: "build-${BUILD_NUMBER}",
            description: 'Docker 이미지 태그 (기본값: build-N)'
        )
    }

    environment {
        AWS_REGION     = 'ap-northeast-2'
        AWS_ACCOUNT_ID = '723165663216'

        // WEB ECR
        ECR_REPO       = 'petclinic-3tier-dev-web'
        ECR_URI        = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"

        // 이미지 태그
        IMAGE_TAG      = "${params.IMAGE_TAG}"
    }

    stages {

        stage('Checkout Source') {
            steps {
                echo "=========================================="
                echo "  WEB Pipeline - Checkout"
                echo "=========================================="
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    echo "Git Commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Verify WEB Files') {
            steps {
                echo "=========================================="
                echo "  Verifying WEB Files"
                echo "=========================================="
                sh '''
                echo "Checking web/ directory..."
                ls -lh web/

                echo "Checking static files..."
                ls -lh web/static/

                echo "Checking Dockerfile..."
                cat web/Dockerfile
                '''
            }
        }

        stage('Login to ECR') {
            steps {
                echo "=========================================="
                echo "  Login to Amazon ECR"
                echo "=========================================="
                sh '''
                aws ecr get-login-password --region $AWS_REGION \
                  | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
                echo "✓ ECR login successful"
                '''
            }
        }

        stage('Build WEB Image') {
            steps {
                echo "=========================================="
                echo "  Building WEB Docker Image"
                echo "=========================================="
                sh '''
                echo "Building: ${ECR_URI}:${IMAGE_TAG}"
                docker build \
                  -f web/Dockerfile \
                  -t ${ECR_URI}:${IMAGE_TAG} \
                  -t ${ECR_URI}:latest \
                  web/

                echo "✓ WEB image built successfully"
                docker images | grep petclinic-3tier-dev-web
                '''
            }
        }

        stage('Push to ECR') {
            steps {
                echo "=========================================="
                echo "  Pushing WEB Image to ECR"
                echo "=========================================="
                sh '''
                echo "Pushing ${ECR_URI}:${IMAGE_TAG}..."
                docker push ${ECR_URI}:${IMAGE_TAG}

                echo "Pushing ${ECR_URI}:latest..."
                docker push ${ECR_URI}:latest

                echo "✓ WEB image pushed to ECR"
                '''
            }
        }
    }

    post {
        success {
            echo "=========================================="
            echo "  WEB Pipeline Success!"
            echo "=========================================="
            echo "Image: ${ECR_URI}:${IMAGE_TAG}"
            echo "Commit: ${env.GIT_COMMIT_SHORT}"
            echo ""
            echo "ECR 이미지 푸시 완료"
            echo "ArgoCD에서 배포 관리"
            echo "=========================================="
        }
        failure {
            echo "=========================================="
            echo "  WEB Pipeline Failed!"
            echo "=========================================="
            echo "Check logs above for error details"
        }
        always {
            sh '''
            echo "Cleaning up Docker images..."
            docker rmi ${ECR_URI}:${IMAGE_TAG} || true
            docker rmi ${ECR_URI}:latest || true
            '''
        }
    }
}
